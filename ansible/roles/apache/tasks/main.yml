---
# ==============================================================================
# LINUX DOMAIN MEMBER SETUP TASKS
# ==============================================================================
# This role joins Linux machines to the Windows Active Directory domain
#
# Students: This creates a mixed Windows/Linux environment - realistic!
#
# What this does:
# 1. Installs required packages (realmd, sssd, Kerberos)
# 2. Configures Kerberos authentication
# 3. Joins the machine to the AD domain
# 4. Configures SSSD for user authentication
# 5. Enables domain user SSH access
# 6. Grants sudo access to specified domain users
#
# Attack scenarios:
# - Exploit Linux machines to pivot to Windows domain
# - Steal Kerberos tickets from Linux (/tmp/krb5cc_*)
# - Attack NFS shares with domain credentials
# - Exploit SSSD vulnerabilities
# - Use Linux as a foothold for domain enumeration
#
# DOCUMENTATION LINKS:
# - Ansible apt module: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html
# - Ansible template module: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html
# - Ansible lineinfile module: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/lineinfile_module.html
# - Ansible handlers: https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_handlers.html
# - realmd (domain join): https://www.freedesktop.org/software/realmd/docs/realm.html
# - SSSD (authentication): https://sssd.io/docs/introduction.html
# - Kerberos (MIT): https://web.mit.edu/kerberos/krb5-latest/doc/

# ------------------------------------------------------------------------------
# STEP 1: Update Package Cache and Install Required Packages
# ------------------------------------------------------------------------------

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600  # Cache valid for 1 hour
  # Students: This ensures we get latest package versions

- name: Install domain membership packages
  ansible.builtin.apt:
    name: "{{ ldm_packages }}"
    state: present
  # This installs ~20 packages, may take 2-3 minutes

# ------------------------------------------------------------------------------
# STEP 2: Configure DNS to Point to Domain Controller
# ------------------------------------------------------------------------------

- name: Get domain controller internal IP
  ansible.builtin.set_fact:
    linux_domain_member_dc_ip: "{{ hostvars[groups['windows_dc'][0]]['internal_ip'] }}"

- name: Configure DNS to use domain controller
  ansible.builtin.template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf
    mode: '0644'
  notify: Restart sssd
  # TEMPLATE MODULE EXPLAINED:
  # - src: Jinja2 template file (looks in roles/linux_domain_member/templates/)
  # - dest: Where to write the rendered file on the target machine
  # - Templates can use variables like {{ domain_name }} which get replaced
  # Docs: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html
  #
  # NOTIFY/HANDLER PATTERN:
  # - notify: Triggers the named handler (Restart sssd) if this task changes something
  # - Handlers run ONCE at the end of the play, even if notified multiple times
  # - Handlers are defined in roles/linux_domain_member/handlers/main.yml
  # Docs: https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_handlers.html

# ------------------------------------------------------------------------------
# STEP 3: Configure Kerberos
# ------------------------------------------------------------------------------
# Kerberos is the authentication protocol used by Active Directory

- name: Configure Kerberos client
  ansible.builtin.template:
    src: krb5.conf.j2
    dest: /etc/krb5.conf
    mode: '0644'
    backup: true  # Keep a backup of original config
  # Students: Check /etc/krb5.conf to see the configuration

# Test Kerberos configuration
- name: Test Kerberos authentication
  ansible.builtin.shell: |
    set -o pipefail
    echo "{{ domain_admin_password }}" | kinit {{ domain_admin_user }}@{{ ldm_realm }}
    klist
  args:
    executable: /bin/bash
  register: linux_domain_member_kinit_test
  changed_when: false
  retries: 5
  delay: 30
  until: linux_domain_member_kinit_test.rc == 0
  # KERBEROS COMMANDS EXPLAINED:
  # - kinit: Obtains a Kerberos Ticket Granting Ticket (TGT) from the KDC (Domain Controller)
  #          The TGT proves your identity and is used to request service tickets
  #          Format: kinit username@REALM (realm must be UPPERCASE)
  #          Docs: https://web.mit.edu/kerberos/krb5-latest/doc/user/user_commands/kinit.html
  #
  # - klist: Lists all Kerberos tickets in the credential cache
  #          Shows TGT expiration time and any service tickets obtained
  #          Docs: https://web.mit.edu/kerberos/krb5-latest/doc/user/user_commands/klist.html
  #
  # SECURITY NOTE FOR STUDENTS:
  # - Tickets are stored in /tmp/krb5cc_* - potential attack target!
  # - An attacker with access to this file can impersonate the user
  # - This is the basis of "Pass-the-Ticket" attacks

- name: Display Kerberos ticket information
  ansible.builtin.debug:
    msg: "{{ linux_domain_member_kinit_test.stdout_lines }}"

# ------------------------------------------------------------------------------
# STEP 4: Join Domain Using realm
# ------------------------------------------------------------------------------

- name: Check if already joined to domain
  ansible.builtin.command: realm list
  register: linux_domain_member_realm_status
  changed_when: false
  failed_when: false

- name: Join domain with realm
  ansible.builtin.shell: |
    set -o pipefail
    echo "{{ domain_admin_password }}" | realm join \
      --user={{ domain_admin_user }} \
      {{ ldm_domain_name }} \
      --verbose
  args:
    executable: /bin/bash
  when: ldm_domain_name not in linux_domain_member_realm_status.stdout
  register: linux_domain_member_realm_join
  changed_when: linux_domain_member_realm_join.rc == 0
  retries: 3
  delay: 30
  until: linux_domain_member_realm_join.rc == 0
  # REALM JOIN EXPLAINED:
  # - realm join: Joins this Linux machine to the Active Directory domain
  #   Docs: https://www.freedesktop.org/software/realmd/docs/realm.html
  #
  # What happens behind the scenes:
  # 1. Creates a computer account in AD (visible in "AD Users and Computers")
  # 2. Generates a machine keytab file (/etc/krb5.keytab)
  # 3. Configures SSSD to authenticate users against AD
  # 4. Sets up PAM to allow domain user logins
  #
  # The password is piped via echo to avoid it appearing in command history
  # --verbose shows detailed progress (useful for troubleshooting)

# ------------------------------------------------------------------------------
# STEP 5: Configure SSSD for Domain Authentication
# ------------------------------------------------------------------------------
# SSSD (System Security Services Daemon) handles authentication

- name: Configure SSSD
  ansible.builtin.template:
    src: sssd.conf.j2
    dest: /etc/sssd/sssd.conf
    mode: '0600'  # Must be readable only by root
    owner: root
    group: root
  notify: Restart sssd

- name: Ensure SSSD is enabled and started
  ansible.builtin.service:
    name: sssd
    state: started
    enabled: true

# ------------------------------------------------------------------------------
# STEP 6: Configure SSH Access for Domain Users
# ------------------------------------------------------------------------------

- name: Allow password authentication in SSH
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication yes'
    state: present
  notify: Restart ssh
  when: ssh_password_authentication | default(true)

- name: Enable GSSAPI authentication (Kerberos)
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?GSSAPIAuthentication'
    line: 'GSSAPIAuthentication yes'
    state: present
  notify: Restart ssh

# Configure PAM to create home directories automatically
- name: Enable automatic home directory creation
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-session
    line: 'session required pam_mkhomedir.so skel=/etc/skel/ umask=0077'
    state: present
  # Students: This creates /home/username@CDT.local on first login

# ------------------------------------------------------------------------------
# STEP 7: Grant Sudo Access to Domain Admins
# ------------------------------------------------------------------------------

- name: Configure sudo access for linux admins
  ansible.builtin.template:
    src: sudoers_domain_admins.j2
    dest: /etc/sudoers.d/domain_admins
    mode: '0440'
    owner: root
    group: root
    validate: 'visudo -cf %s'  # Validate before saving
  when: linux_admins is defined and linux_admins | length > 0
  # Students: This gives specific domain users sudo rights
  # Attack scenario: Compromise these accounts for privilege escalation!

# ------------------------------------------------------------------------------
# STEP 8: Verify Domain Membership
# ------------------------------------------------------------------------------

- name: Verify domain join
  ansible.builtin.command: realm list
  register: linux_domain_member_final_realm_check
  changed_when: false

- name: Display domain membership status
  ansible.builtin.debug:
    msg: "{{ linux_domain_member_final_realm_check.stdout_lines }}"

# Test domain user enumeration
- name: Test domain user enumeration
  ansible.builtin.command: getent passwd {{ domain_users[0].username }}
  register: linux_domain_member_getent_test
  changed_when: false
  failed_when: false
  when: domain_users is defined and domain_users | length > 0

- name: Display user enumeration result
  ansible.builtin.debug:
    msg: "{{ linux_domain_member_getent_test.stdout }}"
  when: linux_domain_member_getent_test.stdout is defined
  # Students: If this works, domain users can login!
  # Try: ssh jdoe@CDT.local@<linux_ip>

# ==============================================================================
# LINUX DOMAIN JOIN COMPLETE!
# ==============================================================================
# Students: Your Linux machine is now part of the Windows domain
#
# Test it out:
# 1. SSH: ssh username@CDT.local@<linux_ip>
# 2. Check tickets: klist (shows Kerberos tickets)
# 3. List users: getent passwd (shows domain users)
# 4. Test sudo: sudo -l (if user is in linux_admins)
#
# Attack practice:
# - Steal Kerberos tickets from /tmp/krb5cc_*
# - Use keytab files for persistence (/etc/krb5.keytab)
# - Exploit SSSD cache (/var/lib/sss/db/)
# - Attack NFS with domain credentials
